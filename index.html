<!DOCTYPE html>
<html class="dark" lang="ja">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Drive Analysis Pro</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "primary-dark": "#0b3db0",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "surface-dark": "#1a2233",
                        "surface-light": "#ffffff",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "2xl": "1rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .radar-grid {
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        body {
            /* Fallback for browsers that don't support dVh */
            min-height: 100vh;
            min-height: 100dvh;
            touch-action: none;
        }

        .warning-flash {
            animation: flash 0.5s infinite alternate;
        }

        @keyframes flash {
            from {
                border-color: rgba(239, 68, 68, 0.2);
                box-shadow: 0 0 0 rgba(239, 68, 68, 0);
            }

            to {
                border-color: rgba(239, 68, 68, 1);
                box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            }
        }

        /* Smooth movement for the G-ball */
        #g-ball {
            transition: transform 0.1s cubic-bezier(0.17, 0.67, 0.83, 0.67);
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 flex flex-col">
    <!-- Overlay for permissions -->
    <div id="permission-overlay" class="fixed inset-0 bg-background-dark/95 z-50 flex items-center justify-center p-6"
        style="display: none;">
        <div class="bg-surface-dark border border-slate-800 p-8 rounded-3xl max-w-md w-full text-center shadow-2xl">
            <span class="material-symbols-outlined text-6xl text-primary mb-6">sensors</span>
            <h2 class="text-2xl font-bold mb-4">センサーへのアクセス許可</h2>
            <p class="text-slate-400 mb-8 text-sm">運転品質を分析するため、モーションセンサーと位置情報へのアクセスを許可してください。</p>
            <button id="grant-btn"
                class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-xl transition-colors active:scale-95 shadow-[0_0_20px_rgba(19,91,236,0.3)]">
                アクセスを許可
            </button>
        </div>
    </div>

    <!-- Top Bar: Status & GPS -->
    <header
        class="w-full px-6 py-4 flex items-center justify-between bg-surface-light dark:bg-surface-dark border-b border-slate-200 dark:border-slate-800 z-10 sticky top-0">
        <div class="flex items-center gap-3">
            <div id="status-icon-container"
                class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-500/20 text-slate-500 transition-colors">
                <span id="status-icon" class="material-symbols-outlined text-[20px]">radio_button_unchecked</span>
            </div>
            <div class="flex flex-col">
                <span
                    class="text-xs text-slate-500 dark:text-slate-400 font-medium uppercase tracking-wider">ステータス</span>
                <span id="status-label" class="text-sm font-bold text-slate-500 transition-colors">待機中</span>
            </div>
        </div>
        <div class="flex-1 text-center hidden sm:block">
            <h1 class="text-lg font-bold tracking-tight">Drive Analysis Pro</h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex flex-col items-end">
                <span
                    class="text-xs text-slate-500 dark:text-slate-400 font-medium uppercase tracking-wider">GPS信号</span>
                <span id="gps-status-text" class="text-sm font-bold text-slate-500">待機中</span>
            </div>
            <div id="gps-icon-container"
                class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-500/20 text-slate-500 transition-colors">
                <span class="material-symbols-outlined text-[20px]">satellite_alt</span>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col lg:flex-row gap-6 p-4 md:p-6 overflow-hidden">
        <!-- Left Column: Metrics & Visualization -->
        <div class="flex-1 flex flex-col gap-6">
            <!-- Key Metrics Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div
                    class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-slate-200 dark:border-slate-800 flex flex-col gap-1">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider">経過時間</span>
                        <span class="material-symbols-outlined text-slate-400 text-[18px]">timer</span>
                    </div>
                    <span id="duration-val" class="text-2xl font-bold font-mono">00:00:00</span>
                </div>
                <div
                    class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-slate-200 dark:border-slate-800 flex flex-col gap-1">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider">速度</span>
                        <span class="material-symbols-outlined text-slate-400 text-[18px]">speed</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span id="speed-val" class="text-2xl font-bold font-mono">0</span>
                        <span class="text-sm text-slate-500">km/h</span>
                    </div>
                </div>
                <div
                    class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-slate-200 dark:border-slate-800 flex flex-col gap-1">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider">横G</span>
                        <span class="material-symbols-outlined text-slate-400 text-[18px]">compare_arrows</span>
                    </div>
                    <span id="lat-g-val" class="text-2xl font-bold font-mono text-primary">0.00g</span>
                </div>
                <div
                    class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-slate-200 dark:border-slate-800 flex flex-col gap-1">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider">前後G</span>
                        <span class="material-symbols-outlined text-slate-400 text-[18px]">height</span>
                    </div>
                    <span id="long-g-val" class="text-2xl font-bold font-mono">0.00g</span>
                </div>
            </div>

            <!-- G-Force Visualization -->
            <div id="radar-wrapper"
                class="flex-1 bg-surface-light dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-800 p-6 relative overflow-hidden flex flex-col transition-colors duration-300">
                <div class="flex items-center justify-between z-10 mb-4">
                    <h2 class="text-lg font-bold">Gモニター</h2>
                    <div class="bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-full text-xs font-medium">リアルタイム</div>
                </div>
                <!-- Radar/Target Visualization -->
                <div id="radar-container"
                    class="flex-1 relative flex items-center justify-center min-h-[250px] radar-grid rounded-xl bg-slate-50 dark:bg-[#151b26] overflow-hidden">
                    <!-- Concentric Circles -->
                    <div class="absolute inset-0 flex items-center justify-center opacity-30 pointer-events-none">
                        <div class="w-3/4 h-3/4 rounded-full border border-slate-400 dark:border-slate-500"></div>
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center opacity-20 pointer-events-none">
                        <div class="w-1/2 h-1/2 rounded-full border border-slate-400 dark:border-slate-500"></div>
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center opacity-10 pointer-events-none">
                        <div class="w-full h-px bg-slate-400 dark:bg-slate-500"></div>
                        <div class="h-full w-px bg-slate-400 dark:bg-slate-500 absolute"></div>
                    </div>
                    <!-- The "Ball" indicating G-Force -->
                    <div id="g-ball"
                        class="absolute w-8 h-8 rounded-full bg-primary shadow-[0_0_15px_rgba(19,91,236,0.8)] border-2 border-white dark:border-slate-900 transform translate-x-0 translate-y-0 z-20 flex items-center justify-center">
                        <div class="w-2 h-2 bg-white/50 rounded-full blur-[1px] -mt-2 -ml-2"></div>
                    </div>
                    <!-- Axis Labels -->
                    <span class="absolute top-4 font-mono text-xs text-slate-400 font-bold">前 +1.0g</span>
                    <span class="absolute bottom-4 font-mono text-xs text-slate-400 font-bold">後 -1.0g</span>
                    <span class="absolute left-4 font-mono text-xs text-slate-400 font-bold">左 1.0g</span>
                    <span class="absolute right-4 font-mono text-xs text-slate-400 font-bold">右 1.0g</span>
                </div>
            </div>
        </div>

        <!-- Right Column: Controls -->
        <div class="w-full lg:w-1/3 flex flex-col gap-6">
            <!-- Large Evaluation Button Section -->
            <button id="bad-ride-btn" style="touch-action: none;"
                class="flex-1 bg-surface-light dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-800 p-8 flex flex-col items-center justify-center relative overflow-hidden group active:scale-[0.98] transition-all cursor-pointer select-none">
                <!-- Background glow for context -->
                <div
                    class="absolute inset-0 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-[#151b26] dark:to-[#1a2233] opacity-50 pointer-events-none">
                </div>

                <h3
                    class="relative z-10 text-lg font-medium mb-8 text-center text-slate-600 dark:text-slate-300 pointer-events-none">
                    危険挙動記録
                </h3>

                <!-- The Button -->
                <div
                    class="relative z-10 w-48 h-48 rounded-full bg-gradient-to-b from-rose-500 to-rose-700 shadow-[0_10px_30px_-10px_rgba(225,29,72,0.6)] flex flex-col items-center justify-center border-4 border-[#1a2b4b] dark:border-[#1e293b] transition-all pointer-events-none">
                    <!-- Inner Ripple Effects -->
                    <span
                        class="absolute inset-0 rounded-full border border-white/20 scale-110 animate-pulse pointer-events-none"></span>
                    <span
                        class="absolute inset-0 rounded-full border border-white/10 scale-125 pointer-events-none"></span>

                    <span
                        class="material-symbols-outlined text-white text-[48px] mb-2 drop-shadow-md pointer-events-none">warning</span>
                    <span
                        class="text-white font-bold text-2xl tracking-wide uppercase drop-shadow-md pointer-events-none">マーク</span>
                </div>

                <p
                    class="relative z-10 mt-8 text-sm text-slate-500 dark:text-slate-400 text-center max-w-[200px] pointer-events-none">
                    乗り心地が悪いと感じている間、<br>押し続けてください。
                </p>
            </button>

            <!-- Secondary Actions -->
            <div class="grid grid-cols-2 gap-4">
                <button id="start-stop-btn"
                    class="bg-surface-light dark:bg-surface-dark border border-slate-200 dark:border-slate-800 p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-[#1e293b] transition-colors active:bg-emerald-500/10">
                    <span id="start-stop-icon"
                        class="material-symbols-outlined text-slate-500 dark:text-slate-400 text-3xl">play_circle</span>
                    <span id="start-stop-text" class="text-sm font-bold">計測開始</span>
                </button>
                <button id="calibrate-btn"
                    class="bg-surface-light dark:bg-surface-dark border border-slate-200 dark:border-slate-800 p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-[#1e293b] transition-colors active:bg-amber-500/10">
                    <span class="material-symbols-outlined text-slate-500 dark:text-slate-400 text-3xl">balance</span>
                    <span class="text-sm font-bold">ゼロ点補正</span>
                </button>
            </div>

            <button id="settings-btn"
                class="w-full bg-surface-light dark:bg-surface-dark border border-slate-200 dark:border-slate-800 p-3 rounded-xl flex items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-[#1e293b] transition-colors">
                <span class="material-symbols-outlined text-slate-500 dark:text-slate-400 text-xl">settings</span>
                <span class="text-xs font-bold text-slate-500">設定を変更</span>
            </button>
        </div>
    </main>

    <!-- Bottom Nav -->
    <nav
        class="bg-surface-light dark:bg-surface-dark border-t border-slate-200 dark:border-slate-800 px-6 pb-6 pt-3 flex justify-around mt-auto">
        <a class="flex flex-col items-center gap-1 group" href="#">
            <div class="p-1 rounded-full bg-primary/10 transition-colors">
                <span class="material-symbols-outlined text-primary text-[24px]">speed</span>
            </div>
            <span class="text-[10px] font-bold text-primary uppercase tracking-wide">モニター</span>
        </a>
        <a class="flex flex-col items-center gap-1 group" href="#">
            <div class="p-1 rounded-full group-hover:bg-slate-100 dark:group-hover:bg-slate-800 transition-colors">
                <span class="material-symbols-outlined text-slate-400 text-[24px]">history</span>
            </div>
            <span class="text-[10px] font-medium text-slate-400 uppercase tracking-wide">履歴</span>
        </a>
        <a class="flex flex-col items-center gap-1 group" href="#">
            <div class="p-1 rounded-full group-hover:bg-slate-100 dark:group-hover:bg-slate-800 transition-colors">
                <span class="material-symbols-outlined text-slate-400 text-[24px]">map</span>
            </div>
            <span class="text-[10px] font-medium text-slate-400 uppercase tracking-wide">マップ</span>
        </a>
        <a class="flex flex-col items-center gap-1 group" href="#"
            onclick="if(sessionData.length > 0) exportCSV(sessionData); else alert('エクスポートするデータがありません。'); return false;">
            <div class="p-1 rounded-full group-hover:bg-slate-100 dark:group-hover:bg-slate-800 transition-colors">
                <span class="material-symbols-outlined text-slate-400 text-[24px]">cloud_download</span>
            </div>
            <span class="text-[10px] font-medium text-slate-400 uppercase tracking-wide">CSV</span>
        </a>
    </nav>

    <!-- Script Area -->
    <script>
        let GAS_URL = localStorage.getItem('gas_url') || "";
        let isRecording = false;
        let startTime = null;
        let timerInterval = null;
        let logInterval = null;
        let wakeLock = null;

        const badRideBtn = document.getElementById('bad-ride-btn');
        const startStopBtn = document.getElementById('start-stop-btn');
        const calibrateBtn = document.getElementById('calibrate-btn');
        const overlay = document.getElementById('permission-overlay');
        const grantBtn = document.getElementById('grant-btn');
        const gBall = document.getElementById('g-ball');
        const settingsBtn = document.getElementById('settings-btn');
        const radarContainer = document.getElementById('radar-container');
        const radarWrapper = document.getElementById('radar-wrapper');
        const statusIcon = document.getElementById('status-icon');
        const statusIconContainer = document.getElementById('status-icon-container');
        const statusLabel = document.getElementById('status-label');
        const durationVal = document.getElementById('duration-val');
        const startStopIcon = document.getElementById('start-stop-icon');
        const startStopText = document.getElementById('start-stop-text');

        let currentData = {
            timestamp: null,
            lat: null,
            lon: null,
            speed: 0,
            accX: 0,
            accY: 0,
            accZ: 0,
            badRide: false
        };
        let sessionData = [];

        // LPF & Calibration variables
        let lpfBeta = 0.2; // スムージング係数
        let filteredAcc = { x: 0, y: 0, z: 0 };
        let offsetAcc = { x: 0, y: 0, z: 0 }; // キャリブレーション用

        // Initialize state
        window.addEventListener('load', () => {
            if (!GAS_URL) {
                GAS_URL = window.prompt("Google Apps ScriptのWeb App URLを入力してください:", "https://script.google.com/macros/s/AKfycbxf16vA2OFLhSxh5a1snngr9aV9MhL8sOtIlTxmIyNQFef3OwmqgrnzbAK2FfltsR5TmA/exec");
                if (GAS_URL) localStorage.setItem('gas_url', GAS_URL);
            }
        });

        settingsBtn.addEventListener('click', () => {
            const newUrl = window.prompt("Webhook URLの変更:", GAS_URL);
            if (newUrl) {
                GAS_URL = newUrl;
                localStorage.setItem('gas_url', GAS_URL);
            }
        });

        calibrateBtn.addEventListener('click', () => {
            offsetAcc.x = currentData.accX;
            offsetAcc.y = currentData.accY;
            offsetAcc.z = currentData.accZ;
            alert('基準値を補正しました。');

            // Visual feedback
            const icon = calibrateBtn.querySelector('.material-symbols-outlined');
            icon.classList.remove('text-slate-500', 'dark:text-slate-400');
            icon.classList.add('text-amber-500');
            setTimeout(() => {
                icon.classList.add('text-slate-500', 'dark:text-slate-400');
                icon.classList.remove('text-amber-500');
            }, 300);
        });

        startStopBtn.addEventListener('click', () => {
            if (!isRecording) {
                overlay.style.display = 'flex';
            } else {
                stopSession();
            }
        });

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) { console.error(`${err.name}, ${err.message}`); }
        }

        grantBtn.addEventListener('click', async () => {
            // Motion Permission (iOS)
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceMotionEvent.requestPermission();
                    if (permission !== 'granted') {
                        alert('モーションセンサーへのアクセスが拒否されました。');
                        return;
                    }
                } catch (e) { console.error(e); }
            }

            // Location Permission
            navigator.geolocation.watchPosition(
                (pos) => {
                    currentData.lat = pos.coords.latitude;
                    currentData.lon = pos.coords.longitude;
                    currentData.speed = (pos.coords.speed || 0) * 3.6;

                    document.getElementById('speed-val').textContent = Math.round(currentData.speed);

                    const gpsStatusText = document.getElementById('gps-status-text');
                    const gpsIconContainer = document.getElementById('gps-icon-container');

                    gpsStatusText.textContent = `良好 (誤差: ${Math.round(pos.coords.accuracy || 0)}m)`;
                    gpsStatusText.className = "text-sm font-bold text-primary";

                    gpsIconContainer.className = "flex items-center justify-center w-8 h-8 rounded-full bg-primary/20 text-primary transition-colors";
                },
                (err) => {
                    console.error(err);
                    const gpsStatusText = document.getElementById('gps-status-text');
                    const gpsIconContainer = document.getElementById('gps-icon-container');

                    gpsStatusText.textContent = "信号ロスト";
                    gpsStatusText.className = "text-sm font-bold text-rose-500";

                    gpsIconContainer.className = "flex items-center justify-center w-8 h-8 rounded-full bg-rose-500/20 text-rose-500 transition-colors";
                },
                { enableHighAccuracy: true }
            );

            // Start Motion Listener
            window.addEventListener('devicemotion', (event) => {
                const acc = event.acceleration || event.accelerationIncludingGravity;
                if (!acc) return;

                currentData.accX = acc.x || 0;
                currentData.accY = acc.y || 0;
                currentData.accZ = acc.z || 0;

                // Apply Calibration
                const rawX = currentData.accX - offsetAcc.x;
                const rawY = currentData.accY - offsetAcc.y;
                const rawZ = currentData.accZ - offsetAcc.z;

                // Apply LPF
                filteredAcc.x = filteredAcc.x * (1 - lpfBeta) + rawX * lpfBeta;
                filteredAcc.y = filteredAcc.y * (1 - lpfBeta) + rawY * lpfBeta;
                filteredAcc.z = filteredAcc.z * (1 - lpfBeta) + rawZ * lpfBeta;

                // Update UI Display (G-force approx)
                const latG = (filteredAcc.x / 9.8);
                const longG = (filteredAcc.y / 9.8);
                const compositeG = Math.sqrt(latG * latG + longG * longG);

                document.getElementById('lat-g-val').textContent = latG.toFixed(2) + 'g';
                document.getElementById('long-g-val').textContent = longG.toFixed(2) + 'g';

                // Map G to radar dimensions.
                // container is relative, sizes adapt. Let's use max transform limits
                const radarWidth = radarContainer.clientWidth;
                // Assuming max scale is 1.0G = half width
                const maxRange = radarWidth / 2 - 16; /* 16 is half the ball size width */
                const scale = maxRange / 1.0;

                const tx = -latG * scale;
                const ty = -longG * scale;

                // Clamp
                const dist = Math.sqrt(tx * tx + ty * ty);
                let finalTx = tx;
                let finalTy = ty;
                if (dist > maxRange) {
                    finalTx = tx * (maxRange / dist);
                    finalTy = ty * (maxRange / dist);
                }

                gBall.style.transform = `translate(${finalTx}px, ${finalTy}px)`;

                // Warning Effect
                if (compositeG > 0.3) {
                    radarWrapper.classList.add('warning-flash', 'border-rose-500');
                    radarWrapper.classList.remove('border-amber-500');
                    gBall.classList.replace('bg-primary', 'bg-rose-500');
                    gBall.style.boxShadow = '0 0 15px rgba(225,29,72,0.8)';
                } else if (compositeG > 0.2) {
                    radarWrapper.classList.remove('warning-flash', 'border-rose-500');
                    radarWrapper.classList.add('border-amber-500');
                    gBall.classList.replace('bg-primary', 'bg-amber-500');
                    gBall.style.boxShadow = '0 0 15px rgba(245,158,11,0.8)';
                } else {
                    radarWrapper.classList.remove('warning-flash', 'border-rose-500', 'border-amber-500');
                    gBall.classList.remove('bg-rose-500', 'bg-amber-500');
                    gBall.classList.add('bg-primary');
                    gBall.style.boxShadow = '0 0 15px rgba(19,91,236,0.8)';
                }
            });

            overlay.style.display = 'none';
            startSession();
        });

        function startSession() {
            isRecording = true;
            startTime = Date.now();
            sessionData = [];
            requestWakeLock();

            // Status UI updates
            statusIcon.textContent = "radio_button_checked";
            statusIconContainer.className = "flex items-center justify-center w-8 h-8 rounded-full bg-emerald-500/20 text-emerald-500 transition-colors";
            statusLabel.textContent = "計測中";
            statusLabel.className = "text-sm font-bold text-emerald-500 transition-colors";

            // Start Btn updates
            startStopIcon.textContent = "stop_circle";
            startStopIcon.className = "material-symbols-outlined text-rose-500 text-3xl transition-colors";
            startStopText.textContent = "計測停止";

            // Timer
            timerInterval = setInterval(() => {
                const diff = new Date(Date.now() - startTime);
                const h = String(diff.getUTCHours()).padStart(2, '0');
                const m = String(diff.getUTCMinutes()).padStart(2, '0');
                const s = String(diff.getUTCSeconds()).padStart(2, '0');
                durationVal.textContent = `${h}:${m}:${s}`;
            }, 1000);

            // Log Loop
            startLogLoop();
        }

        async function stopSession() {
            isRecording = false;
            clearInterval(timerInterval);
            clearInterval(logInterval);
            if (wakeLock) {
                try { await wakeLock.release(); } catch (e) { }
                wakeLock = null;
            }

            sendBatchToGAS();

            // Status UI Reset
            statusIcon.textContent = "radio_button_unchecked";
            statusIconContainer.className = "flex items-center justify-center w-8 h-8 rounded-full bg-slate-500/20 text-slate-500 transition-colors";
            statusLabel.textContent = "待機中";
            statusLabel.className = "text-sm font-bold text-slate-500 transition-colors";

            // Start Btn updates
            startStopIcon.textContent = "play_circle";
            startStopIcon.className = "material-symbols-outlined text-slate-500 dark:text-slate-400 text-3xl transition-colors";
            startStopText.textContent = "計測開始";
        }

        const handleMarkDown = (e) => {
            if (!isRecording) return;
            if (e.cancelable) e.preventDefault(); // prevents default scroll/touch behavior

            currentData.badRide = true;

            // Inner visual feedback
            const innerDiv = badRideBtn.querySelector('div.bg-gradient-to-b');
            innerDiv.classList.replace('from-rose-500', 'from-amber-500');
            innerDiv.classList.replace('to-rose-700', 'to-amber-700');

            // Show pressed effect on shadow
            innerDiv.classList.replace('shadow-[0_10px_30px_-10px_rgba(225,29,72,0.6)]', 'shadow-[0_0_50px_rgba(245,158,11,0.5)]');
        };

        const handleMarkUp = (e) => {
            if (!currentData.badRide) return;
            if (e && e.cancelable) e.preventDefault();

            currentData.badRide = false;

            // Revert visual feedback
            const innerDiv = badRideBtn.querySelector('div.bg-gradient-to-b');
            innerDiv.classList.replace('from-amber-500', 'from-rose-500');
            innerDiv.classList.replace('to-amber-700', 'to-rose-700');
            innerDiv.classList.replace('shadow-[0_0_50px_rgba(245,158,11,0.5)]', 'shadow-[0_10px_30px_-10px_rgba(225,29,72,0.6)]');
        };

        // Support touch and mouse for continuous holding
        badRideBtn.addEventListener('touchstart', handleMarkDown, { passive: false });
        badRideBtn.addEventListener('mousedown', handleMarkDown);

        badRideBtn.addEventListener('touchend', handleMarkUp);
        badRideBtn.addEventListener('touchcancel', handleMarkUp);
        badRideBtn.addEventListener('mouseup', handleMarkUp);
        badRideBtn.addEventListener('mouseleave', handleMarkUp);

        async function sendBatchToGAS() {
            if (!GAS_URL || sessionData.length === 0) return;

            const dataToSend = [...sessionData];
            sessionData = [];

            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });
                alert(`記録データを送信しました (${dataToSend.length}件)`);
            } catch (e) {
                console.error("GAS Send failed", e);
                exportCSV(dataToSend);
            }
        }

        function exportCSV(data) {
            const header = "Timestamp,LatG,LongG,CompositeG,Speed,Marker\n";
            const rows = data.map(d => `${d.timestamp},${d.latG},${d.longG},${d.compositeG},${d.speed},${d.badRide}`).join("\n");
            const blob = new Blob([header + rows], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `drive_log_${new Date().getTime()}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function startLogLoop() {
            logInterval = setInterval(() => {
                if (isRecording) {
                    const latG = (filteredAcc.x / 9.8);
                    const longG = (filteredAcc.y / 9.8);
                    const compositeG = Math.sqrt(latG * latG + longG * longG);

                    sessionData.push({
                        timestamp: new Date().toISOString(),
                        latG: latG.toFixed(3),
                        longG: longG.toFixed(3),
                        compositeG: compositeG.toFixed(3),
                        speed: currentData.speed,
                        badRide: currentData.badRide ? "YES" : ""
                    });
                }
            }, 1000); // 1秒おき
        }
    </script>
</body>

</html>