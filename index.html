<!DOCTYPE html>
<html class="dark" lang="ja">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport" />
    <title>Drive Analysis Pro</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "primary-dark": "#0b3db0",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "surface-dark": "#1a2233",
                        "surface-light": "#ffffff",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "2xl": "1rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        .radar-grid {
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        body {
            min-height: 100dvh;
        }

        /* iOS Safari height fix */
        .min-h-screen {
            min-height: -webkit-fill-available;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 min-h-screen flex flex-col">
    <!-- Top Bar -->
    <header
        class="w-full px-6 py-4 flex items-center justify-between bg-surface-light dark:bg-surface-dark border-b border-slate-200 dark:border-slate-800 z-10 sticky top-0">
        <div class="flex items-center gap-3">
            <div id="recording-indicator"
                class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-500/20 text-slate-500 transition-colors">
                <span class="material-symbols-outlined text-[20px]">radio_button_checked</span>
            </div>
            <div class="flex flex-col">
                <span
                    class="text-xs text-slate-500 dark:text-slate-400 font-medium uppercase tracking-wider">Status</span>
                <span id="status-label" class="text-sm font-bold text-slate-500">Standby</span>
            </div>
        </div>
        <div class="flex-1 text-center hidden sm:block">
            <h1 class="text-lg font-bold tracking-tight">Drive Analysis Pro</h1>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex flex-col items-end">
                <span class="text-xs text-slate-500 dark:text-slate-400 font-medium uppercase tracking-wider">GPS
                    Signal</span>
                <span id="gps-status" class="text-sm font-bold text-slate-500">Waiting...</span>
            </div>
            <div class="flex items-center justify-center w-8 h-8 rounded-full bg-primary/20 text-primary">
                <span class="material-symbols-outlined text-[20px]">satellite_alt</span>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col lg:flex-row gap-6 p-4 md:p-6 overflow-y-auto">
        <!-- Left Column -->
        <div class="flex-1 flex flex-col gap-6">
            <!-- Metrics Grid -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div
                    class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-slate-200 dark:border-slate-800 flex flex-col gap-1">
                    <div class="flex items-center justify-between mb-2">
                        <span
                            class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider">Duration</span>
                        <span class="material-symbols-outlined text-slate-400 text-[18px]">timer</span>
                    </div>
                    <span id="duration-val" class="text-2xl font-bold font-mono">00:00:00</span>
                </div>
                <div
                    class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-slate-200 dark:border-slate-800 flex flex-col gap-1">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider">Speed</span>
                        <span class="material-symbols-outlined text-slate-400 text-[18px]">speed</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span id="speed-val" class="text-2xl font-bold font-mono">0</span>
                        <span class="text-sm text-slate-500">km/h</span>
                    </div>
                </div>
                <div
                    class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-slate-200 dark:border-slate-800 flex flex-col gap-1">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider">Lat G</span>
                        <span class="material-symbols-outlined text-slate-400 text-[18px]">compare_arrows</span>
                    </div>
                    <span id="lat-g-val" class="text-2xl font-bold font-mono text-primary">0.00g</span>
                </div>
                <div
                    class="bg-surface-light dark:bg-surface-dark p-4 rounded-xl border border-slate-200 dark:border-slate-800 flex flex-col gap-1">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-slate-500 dark:text-slate-400 uppercase tracking-wider">Long G</span>
                        <span class="material-symbols-outlined text-slate-400 text-[18px]">height</span>
                    </div>
                    <span id="long-g-val" class="text-2xl font-bold font-mono">0.00g</span>
                </div>
            </div>

            <!-- G-Force Visualization -->
            <div
                class="flex-1 bg-surface-light dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-800 p-6 relative overflow-hidden flex flex-col min-h-[350px]">
                <div class="flex items-center justify-between z-10 mb-4">
                    <h2 class="text-lg font-bold">G-Force Monitor</h2>
                    <div id="live-indicator"
                        class="bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-full text-xs font-medium">Real-time
                    </div>
                </div>
                <div
                    class="flex-1 relative flex items-center justify-center radar-grid rounded-xl bg-slate-50 dark:bg-[#151b26]">
                    <div class="absolute inset-0 flex items-center justify-center opacity-30">
                        <div class="w-3/4 h-3/4 rounded-full border border-slate-400 dark:border-slate-500"></div>
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center opacity-20">
                        <div class="w-1/2 h-1/2 rounded-full border border-slate-400 dark:border-slate-500"></div>
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center opacity-10">
                        <div class="w-full h-px bg-slate-400 dark:bg-slate-500"></div>
                        <div class="h-full w-px bg-slate-400 dark:bg-slate-500 absolute"></div>
                    </div>
                    <!-- G-Force Indicator Ball -->
                    <div id="g-ball"
                        class="absolute w-8 h-8 rounded-full bg-primary shadow-[0_0_20px_rgba(19,91,236,0.6)] border-2 border-white dark:border-slate-900 transition-transform duration-75 ease-out z-20">
                    </div>

                    <span class="absolute top-4 font-mono text-xs text-slate-400">Acc +1.0g</span>
                    <span class="absolute bottom-4 font-mono text-xs text-slate-400">Brk -1.0g</span>
                    <span class="absolute left-4 font-mono text-xs text-slate-400">L 1.0g</span>
                    <span class="absolute right-4 font-mono text-xs text-slate-400">R 1.0g</span>
                </div>
            </div>
        </div>

        <!-- Right Column (Controls) -->
        <div class="w-full lg:w-1/3 flex flex-col gap-6">
            <div
                class="bg-surface-light dark:bg-surface-dark rounded-2xl border border-slate-200 dark:border-slate-800 p-8 flex flex-col items-center justify-center relative overflow-hidden group min-h-[300px]">
                <div
                    class="absolute inset-0 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-[#151b26] dark:to-[#1a2233] opacity-50">
                </div>
                <h3 class="relative z-10 text-lg font-medium mb-8 text-center text-slate-600 dark:text-slate-300">Ride
                    Quality Event</h3>
                <button id="bad-ride-btn"
                    class="relative z-10 w-48 h-48 rounded-full bg-gradient-to-b from-primary to-primary-dark shadow-[0_10px_30px_-10px_rgba(19,91,236,0.6)] flex flex-col items-center justify-center transition-transform active:scale-95 border-4 border-[#1a2b4b] dark:border-[#1e293b]">
                    <span class="material-symbols-outlined text-white text-[48px] mb-2 drop-shadow-md">touch_app</span>
                    <span class="text-white font-bold text-lg tracking-wide uppercase drop-shadow-md">Mark Event</span>
                </button>
                <p class="relative z-10 mt-8 text-sm text-slate-500 dark:text-slate-400 text-center max-w-[200px]">
                    Tap to log a sudden bump, shake, or poor ride quality event.
                </p>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button id="start-stop-btn"
                    class="bg-surface-light dark:bg-surface-dark border border-slate-200 dark:border-slate-800 p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-[#1e293b] transition-colors">
                    <span id="start-stop-icon"
                        class="material-symbols-outlined text-green-500 text-2xl">play_circle</span>
                    <span id="start-stop-text" class="text-sm font-medium">Start Session</span>
                </button>
                <button id="settings-btn"
                    class="bg-surface-light dark:bg-surface-dark border border-slate-200 dark:border-slate-800 p-4 rounded-xl flex flex-col items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-[#1e293b] transition-colors">
                    <span class="material-symbols-outlined text-slate-500 dark:text-slate-400 text-2xl">settings</span>
                    <span class="text-sm font-medium">Settings</span>
                </button>
            </div>
        </div>
    </main>

    <!-- Permission / Permission Prompt -->
    <div id="permission-overlay" class="fixed inset-0 bg-background-dark/95 z-50 flex items-center justify-center p-6"
        style="display: none;">
        <div class="bg-surface-dark border border-slate-800 p-8 rounded-2xl max-w-md w-full text-center">
            <span class="material-symbols-outlined text-6xl text-primary mb-6">sensors</span>
            <h2 class="text-2xl font-bold mb-4">Sensor Permission Required</h2>
            <p class="text-slate-400 mb-8">This app needs access to your device's motion and location sensors to analyze
                your drive quality.</p>
            <button id="grant-btn"
                class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-xl transition-colors">Grant
                Access</button>
        </div>
    </div>

    <!-- Script Area -->
    <script>
        let GAS_URL = localStorage.getItem('gas_url') || "";
        let isRecording = false;
        let startTime = null;
        let timerInterval = null;

        const badRideBtn = document.getElementById('bad-ride-btn');
        const startStopBtn = document.getElementById('start-stop-btn');
        const overlay = document.getElementById('permission-overlay');
        const grantBtn = document.getElementById('grant-btn');
        const gBall = document.getElementById('g-ball');
        const settingsBtn = document.getElementById('settings-btn');

        let currentData = {
            timestamp: null,
            lat: null,
            lon: null,
            speed: 0,
            accX: 0,
            accY: 0,
            accZ: 0,
            badRide: false
        };

        // Initialize state
        window.addEventListener('load', () => {
            if (!GAS_URL) {
                GAS_URL = prompt("Please enter your Google Apps Script Web App URL:");
                if (GAS_URL) localStorage.setItem('gas_url', GAS_URL);
            }
        });

        settingsBtn.addEventListener('click', () => {
            const newUrl = prompt("Update GAS URL:", GAS_URL);
            if (newUrl) {
                GAS_URL = newUrl;
                localStorage.setItem('gas_url', GAS_URL);
            }
        });

        startStopBtn.addEventListener('click', () => {
            if (!isRecording) {
                overlay.style.display = 'flex';
            } else {
                stopSession();
            }
        });

        grantBtn.addEventListener('click', async () => {
            // Motion Permission (iOS)
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceMotionEvent.requestPermission();
                    if (permission !== 'granted') {
                        alert('Motion sensor access denied.');
                        return;
                    }
                } catch (e) { console.error(e); }
            }

            // Location Permission
            navigator.geolocation.watchPosition(
                (pos) => {
                    currentData.lat = pos.coords.latitude;
                    currentData.lon = pos.coords.longitude;
                    currentData.speed = (pos.coords.speed || 0) * 3.6;

                    document.getElementById('speed-val').textContent = Math.round(currentData.speed);
                    document.getElementById('gps-status').textContent = `Acc: ${Math.round(pos.coords.accuracy || 0)}m`;
                    document.getElementById('gps-status').classList.remove('text-slate-500');
                    document.getElementById('gps-status').classList.add('text-primary');
                },
                (err) => {
                    console.error(err);
                    document.getElementById('gps-status').textContent = "Signal Lost";
                    document.getElementById('gps-status').classList.add('text-red-500');
                },
                { enableHighAccuracy: true }
            );

            // Start Motion Listener
            window.addEventListener('devicemotion', (event) => {
                const acc = event.acceleration || event.accelerationIncludingGravity;
                if (!acc) return;

                currentData.accX = acc.x || 0;
                currentData.accY = acc.y || 0;
                currentData.accZ = acc.z || 0;

                // Update UI Display (G-force approx)
                const latG = (acc.x / 9.8);
                const longG = (acc.y / 9.8);

                document.getElementById('lat-g-val').textContent = latG.toFixed(2) + 'g';
                document.getElementById('long-g-val').textContent = longG.toFixed(2) + 'g';

                // Move the G-Ball (Assume 1.0g maps to 100px)
                const scale = 120; // px per G
                const tx = -latG * scale;
                const ty = -longG * scale;

                // Clamp to radar boundaries (assuming radar is approx 300px wide)
                const clampedTx = Math.max(-140, Math.min(140, tx));
                const clampedTy = Math.max(-140, Math.min(140, ty));

                gBall.style.transform = `translate(${clampedTx}px, ${clampedTy}px)`;
            });

            overlay.style.display = 'none';
            startSession();
        });

        function startSession() {
            isRecording = true;
            startTime = Date.now();

            // UI Updates
            document.getElementById('recording-indicator').classList.remove('bg-slate-500/20', 'text-slate-500');
            document.getElementById('recording-indicator').classList.add('bg-emerald-500/20', 'text-emerald-500', 'animate-pulse');
            document.getElementById('status-label').textContent = "Recording";
            document.getElementById('status-label').classList.remove('text-slate-500');
            document.getElementById('status-label').classList.add('text-emerald-500');

            document.getElementById('start-stop-icon').textContent = "stop_circle";
            document.getElementById('start-stop-icon').classList.replace('text-green-500', 'text-red-500');
            document.getElementById('start-stop-text').textContent = "Stop Session";

            // Timer
            timerInterval = setInterval(() => {
                const diff = new Date(Date.now() - startTime);
                const h = String(diff.getUTCHours()).padStart(2, '0');
                const m = String(diff.getUTCMinutes()).padStart(2, '0');
                const s = String(diff.getUTCSeconds()).padStart(2, '0');
                document.getElementById('duration-val').textContent = `${h}:${m}:${s}`;
            }, 1000);

            // Log Loop
            startLogLoop();
        }

        function stopSession() {
            isRecording = false;
            clearInterval(timerInterval);
            clearInterval(logInterval);

            document.getElementById('recording-indicator').classList.remove('bg-emerald-500/20', 'text-emerald-500', 'animate-pulse');
            document.getElementById('recording-indicator').classList.add('bg-slate-500/20', 'text-slate-500');
            document.getElementById('status-label').textContent = "Standby";
            document.getElementById('status-label').classList.replace('text-emerald-500', 'text-slate-500');

            document.getElementById('start-stop-icon').textContent = "play_circle";
            document.getElementById('start-stop-icon').classList.replace('text-red-500', 'text-green-500');
            document.getElementById('start-stop-text').textContent = "Start Session";
        }

        badRideBtn.addEventListener('click', () => {
            if (!isRecording) return;

            currentData.badRide = true;
            // Visual Feedback
            badRideBtn.classList.add('scale-95');
            setTimeout(() => badRideBtn.classList.remove('scale-95'), 100);

            sendToGAS();

            // Reset flag
            setTimeout(() => currentData.badRide = false, 1000);
        });

        async function sendToGAS() {
            if (!GAS_URL || !isRecording) return;

            currentData.timestamp = new Date().toISOString();

            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentData)
                });
            } catch (e) {
                console.error("GAS Send failed", e);
            }
        }

        let logInterval = null;
        function startLogLoop() {
            logInterval = setInterval(() => {
                if (isRecording && !currentData.badRide) {
                    sendToGAS();
                }
            }, 10000); // 10秒おき
        }
    </script>
</body>

</html>